# Cost Engine

**–¢–∏–ø:** Core Service (NestJS + GraphQL)  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ (E/H/W/AGR/SRV/PRD/LOG/PUB/CRB)

## –û–ø–∏—Å–∞–Ω–∏–µ

Cost Engine - —ç—Ç–æ –∫–ª—é—á–µ–≤–æ–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å MorNet GreenCore, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ —Ä–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –æ—Ç Edge-–∞–≥–µ–Ω—Ç–æ–≤ –∏ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. –°–±–æ—Ä —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –¢–∞—Ä–∏—Ñ—ã –Ω–∞ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—é (E)
- –¢–∞—Ä–∏—Ñ—ã –Ω–∞ –æ—Ç–æ–ø–ª–µ–Ω–∏–µ (H)
- –¢–∞—Ä–∏—Ñ—ã –Ω–∞ –≤–æ–¥—É (W)
- –¢–∞—Ä–∏—Ñ—ã –Ω–∞ —Å–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (AGR)
- –¢–∞—Ä–∏—Ñ—ã –Ω–∞ —É—Å–ª—É–≥–∏ (SRV)
- –¢–∞—Ä–∏—Ñ—ã –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (PRD)
- –¢–∞—Ä–∏—Ñ—ã –Ω–∞ –ª–æ–≥–∏—Å—Ç–∏–∫—É (LOG)
- –¢–∞—Ä–∏—Ñ—ã –Ω–∞ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ (PUB)
- –¢–∞—Ä–∏—Ñ—ã –Ω–∞ —É–≥–ª–µ—Ä–æ–¥–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã (CRB)

### 2. –†–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –æ—Ç Oracle Service
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤
- –†–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ —Ñ–æ—Ä–º—É–ª–∞–º
- –£—á—ë—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–æ–Ω (–¥–µ–Ω—å/–Ω–æ—á—å)
- –£—á—ë—Ç —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- **–í—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ:** Oracle Service (—Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è)
- **–ò—Å—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ:** Token Engine (–¥–ª—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–∏)

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Backend:** NestJS, TypeScript
- **API:** GraphQL Federation
- **Database:** PostgreSQL (—Ç–∞—Ä–∏—Ñ—ã, –∏—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á—ë—Ç–æ–≤)
- **Message Queue:** RabbitMQ (–¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏)

## –§–æ—Ä–º—É–ª—ã —Ä–∞—Å—á—ë—Ç–∞

### –≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è (E)
```
Cost_E = ŒîE √ó Tariff_E √ó K_time
–≥–¥–µ:
- ŒîE - –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ (–∫–í—Ç¬∑—á)
- Tariff_E - —Ç–∞—Ä–∏—Ñ –Ω–∞ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—é (‚ÇΩ/–∫–í—Ç¬∑—á)
- K_time - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ (1.0 –¥–µ–Ω—å, 0.7 –Ω–æ—á—å)
```

### –û—Ç–æ–ø–ª–µ–Ω–∏–µ (H)
```
Cost_H = ŒîH √ó Tariff_H √ó K_season
–≥–¥–µ:
- ŒîH - –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –≥–∞–∑–∞/—Ç–µ–ø–ª–∞ (–º¬≥ –∏–ª–∏ –ì–∫–∞–ª)
- Tariff_H - —Ç–∞—Ä–∏—Ñ –Ω–∞ –æ—Ç–æ–ø–ª–µ–Ω–∏–µ (‚ÇΩ/–º¬≥ –∏–ª–∏ ‚ÇΩ/–ì–∫–∞–ª)
- K_season - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏ (1.0 –∑–∏–º–∞, 0.5 –ª–µ—Ç–æ)
```

### –í–æ–¥–∞ (W)
```
Cost_W = ŒîW √ó (Tariff_cold + Tariff_hot √ó K_hot)
–≥–¥–µ:
- ŒîW - –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –≤–æ–¥—ã (–º¬≥)
- Tariff_cold - —Ç–∞—Ä–∏—Ñ –Ω–∞ —Ö–æ–ª–æ–¥–Ω—É—é –≤–æ–¥—É (‚ÇΩ/–º¬≥)
- Tariff_hot - —Ç–∞—Ä–∏—Ñ –Ω–∞ –≥–æ—Ä—è—á—É—é –≤–æ–¥—É (‚ÇΩ/–º¬≥)
- K_hot - –¥–æ–ª—è –≥–æ—Ä—è—á–µ–π –≤–æ–¥—ã (0.0-1.0)
```

## GraphQL Schema

```graphql
type Cost {
  id: ID!
  nodeId: String!
  slotId: String!
  timestamp: DateTime!
  resource: ResourceType!
  consumption: Float!
  tariff: Float!
  cost: Float!
  currency: String!
}

enum ResourceType {
  E   # –≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è
  H   # –û—Ç–æ–ø–ª–µ–Ω–∏–µ
  W   # –í–æ–¥–∞
  AGR # –°–µ–ª—å—Å–∫–æ–µ —Ö–æ–∑—è–π—Å—Ç–≤–æ
  SRV # –£—Å–ª—É–≥–∏
  PRD # –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
  LOG # –õ–æ–≥–∏—Å—Ç–∏–∫–∞
  PUB # –ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
  CRB # –£–≥–ª–µ—Ä–æ–¥–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã
}

type Query {
  getCost(nodeId: String!, slotId: String!): Cost
  getCosts(nodeId: String!, from: DateTime!, to: DateTime!): [Cost!]!
  getTariff(resource: ResourceType!, region: String!): Tariff
}

type Mutation {
  calculateCost(input: CalculateCostInput!): Cost!
  updateTariff(input: UpdateTariffInput!): Tariff!
}

input CalculateCostInput {
  nodeId: String!
  slotId: String!
  resource: ResourceType!
  consumption: Float!
  timestamp: DateTime!
}

input UpdateTariffInput {
  resource: ResourceType!
  region: String!
  value: Float!
  currency: String!
  validFrom: DateTime!
}
```

## Database Schema

```sql
-- –¢–∞–±–ª–∏—Ü–∞ —Ç–∞—Ä–∏—Ñ–æ–≤
CREATE TABLE tariffs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  resource VARCHAR(10) NOT NULL,
  region VARCHAR(100) NOT NULL,
  value DECIMAL(10, 4) NOT NULL,
  currency VARCHAR(3) NOT NULL DEFAULT 'RUB',
  valid_from TIMESTAMP NOT NULL,
  valid_to TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(resource, region, valid_from)
);

-- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—á—ë—Ç–æ–≤ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
CREATE TABLE costs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  node_id VARCHAR(100) NOT NULL,
  slot_id VARCHAR(100) NOT NULL,
  timestamp TIMESTAMP NOT NULL,
  resource VARCHAR(10) NOT NULL,
  consumption DECIMAL(10, 4) NOT NULL,
  tariff DECIMAL(10, 4) NOT NULL,
  cost DECIMAL(10, 2) NOT NULL,
  currency VARCHAR(3) NOT NULL DEFAULT 'RUB',
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(node_id, slot_id, resource)
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_costs_node_id ON costs(node_id);
CREATE INDEX idx_costs_timestamp ON costs(timestamp);
CREATE INDEX idx_tariffs_resource_region ON tariffs(resource, region);
```

## API Endpoints

### REST API (–¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤)

```
POST   /api/v1/costs/calculate    # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
GET    /api/v1/costs/:nodeId      # –ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—á—ë—Ç—ã –¥–ª—è —É–∑–ª–∞
GET    /api/v1/tariffs/:resource  # –ü–æ–ª—É—á–∏—Ç—å —Ç–∞—Ä–∏—Ñ
PUT    /api/v1/tariffs/:id        # –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ
```

### GraphQL API (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤)

```
query GetCost($nodeId: String!, $slotId: String!) {
  getCost(nodeId: $nodeId, slotId: $slotId) {
    id
    resource
    consumption
    tariff
    cost
    currency
  }
}

mutation CalculateCost($input: CalculateCostInput!) {
  calculateCost(input: $input) {
    id
    cost
    currency
  }
}
```

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –†–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–ª—è SmartHome Node 01, Slot S5

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "nodeId": "SmartHome_Node01",
  "slotId": "S5",
  "timestamp": "2025-10-16T20:28:00Z",
  "resources": [
    {
      "type": "E",
      "consumption": 2.90
    },
    {
      "type": "H",
      "consumption": 2.437
    },
    {
      "type": "W",
      "consumption": 0.09
    }
  ]
}
```

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "nodeId": "SmartHome_Node01",
  "slotId": "S5",
  "costs": [
    {
      "resource": "E",
      "consumption": 2.90,
      "tariff": 5.69,
      "cost": 16.50,
      "currency": "RUB"
    },
    {
      "resource": "H",
      "consumption": 2.437,
      "tariff": 5.99,
      "cost": 14.60,
      "currency": "RUB"
    },
    {
      "resource": "W",
      "consumption": 0.09,
      "tariff": 40.00,
      "cost": 3.60,
      "currency": "RUB"
    }
  ],
  "totalCost": 34.70,
  "currency": "RUB"
}
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **Oracle Service** - –∏—Å—Ç–æ—á–Ω–∏–∫ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
- **Token Engine** - –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å —Ä–∞—Å—á—ë—Ç–æ–≤ –¥–ª—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–∏
- **PostgreSQL** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤ –∏ —Ä–∞—Å—á—ë—Ç–æ–≤
- **RabbitMQ** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

## –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

```bash
# Development
pnpm install
pnpm dev

# Production
pnpm build
pnpm start

# Docker
docker build -t mornet/cost-engine .
docker run -p 3004:3004 mornet/cost-engine
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
PORT=3004
DATABASE_URL=postgresql://user:password@localhost:5432/mornet_cost
RABBITMQ_URL=amqp://localhost:5672
ORACLE_SERVICE_URL=http://localhost:3003
TOKEN_ENGINE_URL=http://localhost:3005
```

## –°—Ç–∞—Ç—É—Å

- **–í–µ—Ä—Å–∏—è:** 0.1.0 (MVP)
- **–°—Ç–∞—Ç—É—Å:** üü° –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** 0%

## Roadmap

### MVP 1.0 (Q1 2026)
- [x] –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –¥–∏–∑–∞–π–Ω
- [ ] –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (E/H/W)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Oracle Service
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Token Engine
- [ ] Unit —Ç–µ—Å—Ç—ã

### v1.1 (Q2 2026)
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Tourism —Å–µ–∫—Ç–æ—Ä–∞ (SRV)
- [ ] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ç–∞—Ä–∏—Ñ—ã
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–æ–≤

### v1.2 (Q3 2026)
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Agriculture —Å–µ–∫—Ç–æ—Ä–∞ (AGR)
- [ ] –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤
- [ ] ML-–º–æ–¥–µ–ª–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [Pre-Development Architecture](../../../docs/architecture/pre-development-architecture.md)  
**–ö–æ–º–∞–Ω–¥–∞:** Backend Team  
**–ö–æ–Ω—Ç–∞–∫—Ç:** backend@mornet.io

