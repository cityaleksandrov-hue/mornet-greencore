# Логи проекта

Эта директория содержит логи работы всех компонентов проекта MorNet GreenCore.

## Структура

```
logs/
├── README.md                           # Этот файл
├── smarthome-node01/                   # Логи SmartHome Node 01
│   └── 2025/
│       └── 10/
│           ├── SmartHome_Node01_2025-10-15.md
│           └── SmartHome_Node01_2025-10-16.md
├── edge-agent/                         # Логи Edge-агента (Raspberry Pi)
│   └── 2025/
│       └── 10/
│           ├── rpi_telemetry_2025-10-15.log
│           └── mqtt_2025-10-15.log
└── backend-services/                   # Логи backend микросервисов
    ├── token-engine/
    ├── oracle-service/
    ├── identity-service/
    └── dao-treasury/
```

## Типы логов

### SmartHome Node Logs
**Формат:** Markdown (`.md`)  
**Назначение:** Дневники наблюдений домашних узлов  
**Содержание:**
- Слоты телеметрии (временные интервалы)
- Показания счётчиков (газ, электричество, вода)
- Активности и события
- Расчёт токенов (E/H/W → GCM)
- Фото счётчиков и оборудования

**Пример:** `SmartHome_Node01_2025-10-15.md`

### Edge Agent Logs
**Формат:** Plain text (`.log`) или JSON Lines (`.jsonl`)  
**Назначение:** Технические логи работы Edge-агента  
**Содержание:**
- MQTT публикации (timestamp, topic, payload)
- Системная телеметрия (CPU, RAM, температура)
- Ошибки и предупреждения
- Статус подключения к брокеру

**Пример:** `rpi_telemetry_2025-10-15.log`

### Backend Services Logs
**Формат:** JSON Lines (`.jsonl`) или структурированные логи  
**Назначение:** Логи работы микросервисов  
**Содержание:**
- HTTP запросы и ответы
- Ошибки и исключения
- Транзакции блокчейна
- Метрики производительности

**Пример:** `token-engine_2025-10-15.jsonl`

## Ротация логов

### Ежедневная ротация
Логи создаются ежедневно с датой в имени файла:
```
YYYY-MM-DD_название.log
```

### Архивирование
Логи старше 30 дней автоматически сжимаются:
```bash
gzip logs/edge-agent/2025/09/*.log
```

Логи старше 90 дней перемещаются в архив:
```
logs/archives/2025/Q3/
```

## Уровни логирования

| Уровень | Назначение | Примеры |
|---------|------------|---------|
| **DEBUG** | Детальная отладочная информация | Значения переменных, промежуточные расчёты |
| **INFO** | Информационные сообщения | Успешная публикация в MQTT, завершение слота |
| **WARN** | Предупреждения | Высокая температура CPU, медленный ответ API |
| **ERROR** | Ошибки | Потеря соединения с MQTT, ошибка парсинга данных |
| **FATAL** | Критические ошибки | Недоступность базы данных, сбой системы |

## Формат записей

### Plain Text Logs
```
[2025-10-15 23:24:15] [INFO] MQTT: Published to mornet/node01/telemetry
[2025-10-15 23:25:15] [INFO] CPU: 8.2%, RAM: 15.9%, Temp: 38.0°C
[2025-10-15 23:26:15] [WARN] High CPU usage: 40.0%
```

### JSON Lines Logs
```json
{"timestamp":"2025-10-15T23:24:15Z","level":"INFO","service":"edge-agent","message":"MQTT published","topic":"mornet/node01/telemetry"}
{"timestamp":"2025-10-15T23:25:15Z","level":"INFO","service":"edge-agent","cpu":8.2,"ram":15.9,"temp":38.0}
{"timestamp":"2025-10-15T23:26:15Z","level":"WARN","service":"edge-agent","message":"High CPU usage","cpu":40.0}
```

## Мониторинг логов

### Просмотр в реальном времени
```bash
# Следить за логами Edge-агента
tail -f logs/edge-agent/2025/10/rpi_telemetry_2025-10-15.log

# Фильтровать только ошибки
tail -f logs/edge-agent/2025/10/rpi_telemetry_2025-10-15.log | grep ERROR
```

### Поиск по логам
```bash
# Найти все ошибки за день
grep ERROR logs/edge-agent/2025/10/rpi_telemetry_2025-10-15.log

# Найти упоминания MQTT
grep -r "MQTT" logs/edge-agent/2025/10/
```

### Анализ логов
```bash
# Подсчитать количество ошибок
grep -c ERROR logs/edge-agent/2025/10/*.log

# Показать последние 50 записей
tail -n 50 logs/edge-agent/2025/10/rpi_telemetry_2025-10-15.log
```

## Git и логи

⚠️ **Важно:** Логи НЕ должны коммититься в Git!

Добавлено в `.gitignore`:
```gitignore
# Логи
logs/**/*.log
logs/**/*.jsonl
logs/**/*.gz

# Исключение: Markdown дневники SmartHome Node
!logs/smarthome-node01/**/*.md
```

**Причины:**
- Большой объём данных (гигабайты)
- Частые изменения (каждую минуту)
- Содержат персональные данные
- Не являются исходным кодом

**Исключение:** Markdown дневники SmartHome Node могут коммититься, так как:
- Небольшой размер (10-50 КБ)
- Редкие обновления (раз в день)
- Содержат осмысленную информацию
- Важны для истории проекта

## Хранение логов

### Локальное хранение
- На Edge-устройствах (Raspberry Pi): 7 дней
- На сервере: 30 дней (активные) + 90 дней (архив)

### Облачное хранение
- Yandex Object Storage / S3: долгосрочное хранение (1+ год)
- TimescaleDB: агрегированные метрики (бесконечно)

## Безопасность

⚠️ **Логи могут содержать чувствительные данные:**
- IP-адреса и идентификаторы устройств
- Паттерны поведения пользователей
- Технические детали инфраструктуры

**Меры защиты:**
1. Анонимизация (Node ID вместо адреса)
2. Шифрование при передаче (TLS)
3. Ограничение доступа (только авторизованные пользователи)
4. Регулярная очистка старых логов

---

**Последнее обновление:** 16 октября 2025

